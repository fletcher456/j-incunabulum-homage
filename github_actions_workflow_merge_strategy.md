# GitHub Actions Workflow Merge Strategy
## Unified WASM Build and Pages Deployment

**Date**: June 24, 2025  
**Issue**: Artifact isolation between separate workflow runs preventing WASM deployment  
**Solution**: Merge rust.yml and pages-deploy.yml into single unified workflow  

## Problem Analysis

### Current Architecture Issue
```
rust.yml workflow run:
├── Builds WASM artifacts
├── Uploads to run-specific storage
└── Artifacts isolated to this run

pages-deploy.yml workflow run:
├── Cannot access rust.yml artifacts
├── Missing WASM files for deployment
└── Deployment fails without required assets
```

### GitHub Actions Artifact Scope
- **Workflow Run Isolation**: Artifacts are scoped to individual workflow runs
- **Cross-Run Access**: No built-in mechanism for accessing artifacts from different runs
- **Security Model**: Prevents unauthorized access to build artifacts
- **Design Intent**: Workflows should be self-contained for security and reliability

## Solution: Unified Workflow Strategy

### Single Workflow Architecture
```
unified-deploy.yml:
├── Job 1: Build WASM
│   ├── Rust compilation
│   ├── wasm-pack build
│   └── Artifact creation
├── Job 2: Deploy Pages (depends on Job 1)
│   ├── Download WASM artifacts
│   ├── Combine with frontend files
│   └── Deploy to GitHub Pages
```

### Workflow Dependencies
- **Sequential Execution**: Pages deployment waits for WASM build completion
- **Artifact Sharing**: Within-run artifact transfer between jobs
- **Failure Handling**: WASM build failure prevents deployment attempt
- **Atomic Operations**: Single workflow success/failure status

## Implementation Plan

### Phase 1: Workflow Analysis (10 minutes)

#### Current rust.yml Content Analysis
```yaml
# Key components to preserve:
- Rust toolchain setup
- WASM target installation
- wasm-pack build process
- Artifact upload strategy
- Error handling and logging
```

#### Current pages-deploy.yml Content Analysis
```yaml
# Key components to preserve:
- Pages deployment permissions
- Static file organization
- Deployment configuration
- Environment setup
```

### Phase 2: Unified Workflow Design (20 minutes)

#### New Workflow Structure
```yaml
name: Build WASM and Deploy to Pages
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
      - name: Setup Rust toolchain
      - name: Install WASM target
      - name: Build WASM package
      - name: Upload WASM artifacts
    
  deploy-pages:
    needs: build-wasm
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
      - name: Download WASM artifacts
      - name: Organize deployment files
      - name: Deploy to GitHub Pages
```

#### Artifact Flow Design
```yaml
# In build-wasm job:
- name: Upload WASM artifacts
  uses: actions/upload-artifact@v4
  with:
    name: wasm-package
    path: simple_server/pkg/
    retention-days: 1

# In deploy-pages job:
- name: Download WASM artifacts
  uses: actions/download-artifact@v4
  with:
    name: wasm-package
    path: pages-demo/wasm/
```

### Phase 3: File Organization Strategy (15 minutes)

#### Pages Demo Directory Structure
```
pages-demo/
├── index.html              # Main interface
├── css/style.css          # Styling
├── js/
│   ├── app-init.js        # WASM initialization
│   ├── wasm-adapter.js    # WASM interface
│   └── wasm-loader.js     # Module loading
├── wasm/                  # WASM files (from artifacts)
│   ├── simple_server.js   # Generated by wasm-pack
│   ├── simple_server.wasm # Compiled WebAssembly
│   └── simple_server_bg.wasm.d.ts
└── assets/
    └── .gitkeep
```

#### Deployment File Combination
```yaml
- name: Organize deployment files
  run: |
    # Create deployment directory
    mkdir -p deployment
    
    # Copy frontend files
    cp -r pages-demo/* deployment/
    
    # Ensure WASM directory exists
    mkdir -p deployment/wasm
    
    # WASM files already downloaded to pages-demo/wasm/
    
    # Verify required files exist
    ls -la deployment/wasm/
```

### Phase 4: Permissions and Configuration (10 minutes)

#### Required Permissions
```yaml
permissions:
  contents: read      # Repository access
  pages: write        # Pages deployment
  id-token: write     # Authentication
  actions: read       # Artifact access
```

#### Environment Configuration
```yaml
environment:
  name: github-pages
  url: ${{ steps.deployment.outputs.page_url }}
```

## Risk Mitigation

### Build Failure Handling
- **WASM Build Fails**: Pages deployment skipped, clear error message
- **Artifact Missing**: Explicit verification before deployment
- **Dependency Issues**: Early detection with comprehensive logging

### Rollback Strategy
- **Workflow Failure**: Previous working deployment remains active
- **Configuration Backup**: Original workflows preserved in git history
- **Quick Recovery**: Revert commit to restore separate workflows

### Testing Approach
- **Pull Request Testing**: Workflow runs on PR without deployment
- **Branch Protection**: Prevent direct pushes to main
- **Staged Rollout**: Test on feature branch first

## Implementation Steps

### Step 1: Create Unified Workflow
```bash
# Create new unified workflow file
.github/workflows/unified-deploy.yml

# Combine logic from both existing workflows
# Test with careful job dependencies
```

### Step 2: Validate Configuration
```bash
# Syntax validation
# Dependency verification
# Permission checking
```

### Step 3: Safe Deployment
```bash
# Rename old workflows (disable)
# Push unified workflow
# Monitor first deployment
```

### Step 4: Cleanup
```bash
# Remove old workflow files after success
# Update documentation
# Verify Pages deployment
```

## Expected Outcomes

### Successful Integration
- **Single Workflow**: Unified build and deployment process
- **Artifact Access**: WASM files available to Pages deployment
- **Reliable Deployment**: Consistent success without artifact isolation issues
- **Maintainability**: Single workflow to maintain and debug

### Performance Benefits
- **Faster Deployment**: No cross-workflow delays
- **Resource Efficiency**: Shared setup and caching
- **Atomic Operations**: Build and deploy as single unit
- **Clear Status**: Single workflow success/failure indication

### User Experience
- **Reliable Updates**: Every push triggers complete deployment
- **Consistent State**: WASM and frontend always synchronized
- **Clear Feedback**: Single workflow status for entire deployment
- **Professional Hosting**: GitHub Pages with automatic TLS and CDN

## Technical Specifications

### Workflow Triggers
```yaml
on:
  push:
    branches: [ main ]
    paths:
      - 'simple_server/**'
      - 'pages-demo/**'
      - '.github/workflows/unified-deploy.yml'
```

### Caching Strategy
```yaml
- name: Cache Rust dependencies
  uses: actions/cache@v3
  with:
    path: |
      ~/.cargo/registry
      ~/.cargo/git
      simple_server/target
    key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
```

### Error Handling
```yaml
- name: Verify WASM build
  run: |
    if [ ! -f "simple_server/pkg/simple_server.js" ]; then
      echo "WASM build failed - required files missing"
      exit 1
    fi
    echo "WASM build successful"
```

## Success Criteria

### Technical Validation
- [ ] Unified workflow syntax validates correctly
- [ ] WASM build completes without errors
- [ ] Artifacts transfer between jobs successfully
- [ ] Pages deployment accesses WASM files
- [ ] Live site loads and functions correctly

### Functional Validation
- [ ] Calculator interface displays properly
- [ ] WASM module loads and initializes
- [ ] Expression evaluation returns correct results
- [ ] Error handling provides appropriate feedback
- [ ] Mobile responsiveness works correctly

### Operational Validation
- [ ] Workflow completes within reasonable time
- [ ] Resource usage remains efficient
- [ ] Error messages are clear and actionable
- [ ] Monitoring and debugging are straightforward
- [ ] Rollback process is well-defined

## Conclusion

Merging the separate rust.yml and pages-deploy.yml workflows into a unified deployment pipeline resolves the artifact isolation issue while improving maintainability and reliability. This approach ensures WASM artifacts are available to the Pages deployment job within the same workflow run, enabling successful deployment of the complete J language interpreter application to GitHub Pages.

**Next Action**: Implement the unified workflow with careful job dependencies and comprehensive error handling.